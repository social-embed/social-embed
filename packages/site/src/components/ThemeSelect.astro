---
/**
 * Custom theme selector with icon-based UX
 * Keeps Starlight's data handling, replaces dropdown with icon buttons
 *
 * Desktop: Horizontal button group with 3 icons (Sun, Computer, Moon)
 * Mobile: Single toggle button that cycles through options
 */

// Button base classes
const btnBase =
  "px-2 py-1 mx-0.5 inline-flex items-center justify-center rounded-sm cursor-pointer bg-transparent text-slate-600 dark:text-slate-400 hover:bg-slate-100/70 dark:hover:bg-slate-700/40";

// Active state classes using data-active attribute
const activeState =
  "[&[data-active='true']]:bg-slate-200 [&[data-active='true']]:text-slate-900 dark:[&[data-active='true']]:bg-slate-700 dark:[&[data-active='true']]:text-slate-100";
---

<starlight-theme-select>
  <!-- Desktop: Icon button group -->
  <div class="hidden lg:block">
    <div
      role="group"
      aria-label={Astro.locals.t("themeSelect.accessibleLabel")}
      class="inline-flex items-center justify-center p-0.5 h-8 rounded-md bg-slate-50/95 dark:bg-slate-800/95 border border-slate-200 dark:border-slate-700 shadow-sm"
    >
      <button
        data-theme-value="light"
        type="button"
        aria-label={Astro.locals.t("themeSelect.light")}
        class:list={[btnBase, activeState]}
      >
        <svg
          class="h-4 w-4"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
      </button>
      <button
        data-theme-value="auto"
        type="button"
        aria-label={Astro.locals.t("themeSelect.auto")}
        class:list={[btnBase, activeState]}
      >
        <svg
          class="h-4 w-4"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
          <line x1="8" y1="21" x2="16" y2="21"></line>
          <line x1="12" y1="17" x2="12" y2="21"></line>
        </svg>
      </button>
      <button
        data-theme-value="dark"
        type="button"
        aria-label={Astro.locals.t("themeSelect.dark")}
        class:list={[btnBase, activeState]}
      >
        <svg
          class="h-4 w-4"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile: Cycle toggle (single button) -->
  <div class="block lg:hidden">
    <button
      data-theme-toggle
      type="button"
      aria-label={Astro.locals.t("themeSelect.accessibleLabel")}
      class="flex items-center justify-center h-8 w-8 rounded-md cursor-pointer bg-slate-50/95 dark:bg-slate-800/95 border border-slate-200 dark:border-slate-700 shadow-sm text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700/50"
    >
      <!-- Sun (shown in light) -->
      <svg
        data-icon="light"
        class="h-4 w-4 hidden"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        viewBox="0 0 24 24"
      >
        <circle cx="12" cy="12" r="5"></circle>
        <line x1="12" y1="1" x2="12" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="23"></line>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
        <line x1="1" y1="12" x2="3" y2="12"></line>
        <line x1="21" y1="12" x2="23" y2="12"></line>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
      </svg>
      <!-- Computer (shown in auto) -->
      <svg
        data-icon="auto"
        class="h-4 w-4 hidden"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        viewBox="0 0 24 24"
      >
        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
        <line x1="8" y1="21" x2="16" y2="21"></line>
        <line x1="12" y1="17" x2="12" y2="21"></line>
      </svg>
      <!-- Moon (shown in dark) -->
      <svg
        data-icon="dark"
        class="h-4 w-4 hidden"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        viewBox="0 0 24 24"
      >
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
      </svg>
    </button>
  </div>
</starlight-theme-select>

{/* Inlined to avoid FOUC - runs immediately before custom element is defined */}
<script is:inline>
  StarlightThemeProvider.updatePickers();
</script>

<script>
  type Theme = "auto" | "dark" | "light";

  // Declare the global StarlightThemeProvider injected by Starlight's ThemeProvider.astro
  declare global {
    const StarlightThemeProvider: {
      updatePickers: (theme?: Theme) => void;
    };
  }

  const storageKey = "starlight-theme";
  const THEMES: Theme[] = ["light", "auto", "dark"];

  const parseTheme = (theme: unknown): Theme =>
    theme === "auto" || theme === "dark" || theme === "light" ? theme : "auto";

  const loadTheme = (): Theme =>
    parseTheme(
      typeof localStorage !== "undefined" && localStorage.getItem(storageKey),
    );

  function storeTheme(theme: Theme): void {
    if (typeof localStorage !== "undefined") {
      localStorage.setItem(
        storageKey,
        theme === "light" || theme === "dark" ? theme : "",
      );
    }
  }

  const getPreferredColorScheme = (): Theme =>
    matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark";

  function onThemeChange(theme: Theme): void {
    StarlightThemeProvider.updatePickers(theme);
    document.documentElement.dataset.theme =
      theme === "auto" ? getPreferredColorScheme() : theme;
    storeTheme(theme);
    updateButtonStates(theme);
  }

  function updateButtonStates(theme: Theme): void {
    document.querySelectorAll("starlight-theme-select").forEach((picker) => {
      // Update desktop button active states
      picker.querySelectorAll("[data-theme-value]").forEach((btn) => {
        const isActive = btn.getAttribute("data-theme-value") === theme;
        btn.setAttribute("data-active", isActive ? "true" : "false");
      });
      // Update mobile icon visibility
      picker.querySelectorAll("[data-icon]").forEach((icon) => {
        const show = icon.getAttribute("data-icon") === theme;
        icon.classList.toggle("hidden", !show);
        icon.classList.toggle("block", show);
      });
    });
  }

  // Listen for system preference changes when in auto mode
  matchMedia("(prefers-color-scheme: light)").addEventListener("change", () => {
    if (loadTheme() === "auto") onThemeChange("auto");
  });

  class StarlightThemeSelect extends HTMLElement {
    constructor() {
      super();
      const currentTheme = loadTheme();
      onThemeChange(currentTheme);

      // Desktop buttons - direct click handlers
      this.querySelectorAll("[data-theme-value]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const theme = parseTheme(btn.getAttribute("data-theme-value"));
          onThemeChange(theme);
        });
      });

      // Mobile toggle - cycle through themes
      this.querySelector("[data-theme-toggle]")?.addEventListener(
        "click",
        () => {
          const current = loadTheme();
          const idx = THEMES.indexOf(current);
          const next = THEMES[(idx + 1) % THEMES.length];
          onThemeChange(next);
        },
      );
    }
  }
  customElements.define("starlight-theme-select", StarlightThemeSelect);
</script>
