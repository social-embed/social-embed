---
import MobileNavToggle from "../components/docs/MobileNavToggle.astro";
import MobileSidebar from "../components/docs/MobileSidebar.astro";
import MobileToC from "../components/docs/MobileToC.astro";
import TableOfContents from "../components/docs/TableOfContents.astro";
import { generateToC } from "../lib/generateToC";
/**
 * Layout for documentation/markdown pages.
 * Provides 3-column layout: sidebar | content | table of contents
 * Mobile: slide-out panels for sidebar and ToC
 */
import BaseLayout from "./BaseLayout.astro";

interface Props {
  frontmatter: {
    title: string;
    description?: string;
    tableOfContents?: boolean;
    head?: Array<{
      tag: string;
      content?: string;
      attrs?: Record<string, string>;
    }>;
  };
  headings?: Array<{ depth: number; slug: string; text: string }>;
}

const { frontmatter, headings = [] } = Astro.props;
const showToC = frontmatter.tableOfContents !== false;
const tocItems = showToC
  ? generateToC(headings, { maxLevel: 3, minLevel: 2 })
  : [];
---

<BaseLayout
  title={frontmatter.title}
  description={frontmatter.description}
  head={frontmatter.head}
>
  <!-- Mobile navigation toggles in header -->
  <MobileNavToggle slot="mobile-toggles" showToC={tocItems.length > 0} />

  <!-- Mobile slide-out panels -->
  <MobileSidebar currentPath={Astro.url.pathname} />
  {tocItems.length > 0 && <MobileToC items={tocItems} />}

  <div class="markdown-layout">
    <!-- Left sidebar (populated by page or parent) -->
    <aside class="sidebar-left">
      <slot name="sidebar" />
    </aside>

    <!-- Main content area -->
    <main class="main-content">
      <article class="prose">
        <h1>{frontmatter.title}</h1>
        <slot />
      </article>
    </main>

    <!-- Table of Contents (right sidebar) -->
    {
      tocItems.length > 0 && (
        <aside class="sidebar-right">
          <TableOfContents items={tocItems} />
        </aside>
      )
    }
  </div>
</BaseLayout>

<style>
  .markdown-layout {
    display: flex;
    max-width: 90rem;
    margin: 0 auto;
    min-height: calc(100vh - var(--nav-height));
  }

  /* Left sidebar */
  .sidebar-left {
    display: none;
    width: 16rem;
    flex-shrink: 0;
    border-right: 1px solid var(--color-slate-200);
    padding: 1.5rem 1rem;
  }

  :global([data-theme="dark"]) .sidebar-left {
    border-right-color: var(--color-slate-700);
  }

  @media (min-width: 1024px) {
    .sidebar-left {
      display: block;
    }
  }

  /* Main content */
  .main-content {
    flex: 1;
    min-width: 0;
    padding: 1.5rem 1rem;
  }

  @media (min-width: 640px) {
    .main-content {
      padding: 1.5rem 2rem;
    }
  }

  @media (min-width: 1024px) {
    .main-content {
      padding: 1.5rem 3rem;
    }
  }

  /* Right sidebar (ToC) */
  .sidebar-right {
    display: none;
    width: 14rem;
    flex-shrink: 0;
    padding: 1.5rem 1rem;
  }

  @media (min-width: 1280px) {
    .sidebar-right {
      display: block;
    }
  }

  /* Prose styling for markdown content */
  .prose {
    max-width: 75ch;
    color: var(--color-slate-700);
    line-height: 1.75;
  }

  :global([data-theme="dark"]) .prose {
    color: var(--color-slate-300);
  }

  .prose :global(h1) {
    font-size: 2.25rem;
    font-weight: 700;
    line-height: 1.2;
    margin-bottom: 1rem;
    color: var(--color-slate-900);
  }

  :global([data-theme="dark"]) .prose :global(h1) {
    color: var(--color-slate-100);
  }

  .prose :global(h2) {
    font-size: 1.5rem;
    font-weight: 600;
    line-height: 1.3;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    color: var(--color-slate-900);
    scroll-margin-top: calc(var(--nav-height) + 1rem);
  }

  :global([data-theme="dark"]) .prose :global(h2) {
    color: var(--color-slate-100);
  }

  .prose :global(h3) {
    font-size: 1.25rem;
    font-weight: 600;
    line-height: 1.4;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
    color: var(--color-slate-900);
    scroll-margin-top: calc(var(--nav-height) + 1rem);
  }

  :global([data-theme="dark"]) .prose :global(h3) {
    color: var(--color-slate-100);
  }

  .prose :global(p) {
    margin-top: 1rem;
    margin-bottom: 1rem;
  }

  .prose :global(a) {
    color: var(--color-mv-blue);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .prose :global(a:hover) {
    color: color-mix(in oklch, var(--color-mv-blue), black 20%);
  }

  :global([data-theme="dark"]) .prose :global(a) {
    color: color-mix(in oklch, var(--color-mv-blue), white 20%);
  }

  :global([data-theme="dark"]) .prose :global(a:hover) {
    color: color-mix(in oklch, var(--color-mv-blue), white 35%);
  }

  .prose :global(code) {
    font-family: var(--font-mono);
    font-size: 0.875em;
    background: var(--color-slate-100);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
  }

  :global([data-theme="dark"]) .prose :global(code) {
    background: var(--color-slate-800);
  }

  .prose :global(pre) {
    margin: 1.5rem 0;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    background: var(--color-slate-900);
    color: var(--color-slate-100);
  }

  .prose :global(pre code),
  :global([data-theme="dark"]) .prose :global(pre code) {
    background: transparent;
    padding: 0;
    font-size: 0.875rem;
    line-height: 1.6;
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin: 1rem 0;
    padding-left: 1.5rem;
  }

  .prose :global(li) {
    margin: 0.375rem 0;
  }

  .prose :global(blockquote) {
    border-left: 3px solid var(--color-slate-300);
    padding-left: 1rem;
    margin: 1.5rem 0;
    color: var(--color-slate-600);
    font-style: italic;
  }

  :global([data-theme="dark"]) .prose :global(blockquote) {
    border-left-color: var(--color-slate-600);
    color: var(--color-slate-400);
  }

  .prose :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    font-size: 0.875rem;
  }

  .prose :global(th),
  .prose :global(td) {
    border: 1px solid var(--color-slate-200);
    padding: 0.5rem 0.75rem;
    text-align: left;
  }

  :global([data-theme="dark"]) .prose :global(th),
  :global([data-theme="dark"]) .prose :global(td) {
    border-color: var(--color-slate-700);
  }

  .prose :global(th) {
    background: var(--color-slate-50);
    font-weight: 600;
  }

  :global([data-theme="dark"]) .prose :global(th) {
    background: var(--color-slate-800);
  }

  .prose :global(hr) {
    border: none;
    border-top: 1px solid var(--color-slate-200);
    margin: 2rem 0;
  }

  :global([data-theme="dark"]) .prose :global(hr) {
    border-top-color: var(--color-slate-700);
  }

  /* Anchor links on headings */
  .prose :global(.anchor-link) {
    opacity: 0;
    margin-left: 0.5rem;
    color: var(--color-slate-400);
    text-decoration: none;
  }

  .prose :global(h2:hover .anchor-link),
  .prose :global(h3:hover .anchor-link) {
    opacity: 1;
  }

  .prose :global(.anchor-link:hover) {
    color: var(--color-mv-blue);
  }

  /* Embedded media */
  .prose :global(iframe),
  .prose :global(video) {
    max-width: 100%;
    margin: 1.5rem 0;
    border-radius: 0.5rem;
  }

  /* Images */
  .prose :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
  }
</style>
